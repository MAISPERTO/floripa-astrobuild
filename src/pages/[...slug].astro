---
// src/pages/[...slug].astro (VERSﾃグ FINAL COM LOGO E TAGLINE)

import client from '../lib/directus';
import { readItems, type Item } from '@directus/sdk';
import MainLayout from '../layouts/MainLayout.astro';
import CardSection from '../components/CardSection.astro';ﾂ
import Breadcrumbs from '../components/Breadcrumbs.astro';ﾂ

// VARIﾃ〃EIS DE AMBIENTE: DEFINIDAS NO ESCOPO EXTERNO
const DIRECTUS_BASE_URL = import.meta.env.PUBLIC_DIRECTUS_URL || "";
const CITY_SLUG = import.meta.env.PUBLIC_CITY_SLUG || "floripa";ﾂ
const CITY_NAME = import.meta.env.PUBLIC_CITY_NAME || "Florianﾃｳpolis";

// 泙 NOVO: Definiﾃｧﾃ｣o do Nome do Site Dinﾃ｢mico (Ex: Floripa.MP, Sjc.MP)
const SITE_SLUG_CAPITALIZED = CITY_SLUG.charAt(0).toUpperCase() + CITY_SLUG.slice(1);
const SITE_NAME = `${SITE_SLUG_CAPITALIZED}.MP`;
const SITE_TAGLINE = "Negﾃｳcios Locais"; // 泙 NOVO: Tagline

// Tipagem e Utilitﾃ｡rios (mantidos)
interface Crumb { label: string; href: string | null };

// Funﾃｧﾃ｣o utilitﾃ｡ria: Revertida para a versﾃ｣o simples, pois nﾃ｣o lemos mais M:M complexo
function getId(value: any): number | string | null {
ﾂ if (value == null) return null;
ﾂ if (typeof value === 'number' || typeof value === 'string') return value;
ﾂﾂ
ﾂ if (typeof value === 'object') {
ﾂ ﾂ ﾂ // **VERIFICAﾃﾃグ M:M PARA BAIRROS (Novo/Restaurado)**
ﾂ ﾂ ﾂ // Assume que o campo de relacionamento ﾃｩ mp_bairros_id na tabela intermediﾃ｡ria.
ﾂ ﾂ ﾂ if (value.mp_bairros_id) return getId(value.mp_bairros_id);ﾂ
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ // Caso contrﾃ｡rio, retorna o ID do objeto simples (para M:1 ou objetos aninhados)
ﾂ ﾂ ﾂ if ('id' in value) return (value as any).id;
ﾂ }
ﾂ return null;
}

/**
ﾂ* 1) getStaticPaths: Define todas as URLs vﾃ｡lidas
ﾂ*/
export async function getStaticPaths() {
ﾂﾂ
ﾂ // SOLUﾃﾃグ DO ERRO DE SCOPE
ﾂ const citySlugForStaticPaths = import.meta.env.PUBLIC_CITY_SLUG || "floripa";

ﾂ // Buscar o ID da cidade no Directus pelo SLUG
ﾂ const cidade = await client.request(
ﾂ ﾂ readItems('mp_cidades', {
ﾂ ﾂ ﾂ filter: { slug_cidade: { _eq: citySlugForStaticPaths } },ﾂ
ﾂ ﾂ ﾂ fields: ['id'],
ﾂ ﾂ ﾂ limit: 1,
ﾂ ﾂ })
ﾂ );

ﾂ const CIDADE_ID = cidade[0]?.id;
ﾂ if (!CIDADE_ID) {
ﾂ ﾂ console.error(`CIDADE_ID para ${citySlugForStaticPaths} nﾃ｣o encontrado. Rota desativada.`);
ﾂ ﾂ return [];
ﾂ }

ﾂ // Todas as categorias/nichos ativas (SEM FILTRO DE CIDADE)
ﾂ const categorias = await client.request(
ﾂ ﾂ readItems('mp_categorias_locais', {
ﾂ ﾂ ﾂ filter: { ativo: { _eq: true } },
ﾂ ﾂ ﾂ fields: ['id', 'full_slug_nicho'],
ﾂ ﾂ ﾂ limit: -1,
ﾂ ﾂ })
ﾂ );

ﾂ // Todos os bairros/regiﾃｵes ativos (FILTRO M:1)
ﾂ const bairros = await client.request(
ﾂ ﾂ readItems('mp_bairros', {
ﾂ ﾂ ﾂ filter: {
ﾂ ﾂ ﾂ ﾂ ativo: { _eq: true },
ﾂ ﾂ ﾂ ﾂ status: { _eq: 'published' },
ﾂ ﾂ ﾂ ﾂ cidade_relacionada: { _eq: CIDADE_ID }ﾂ
ﾂ ﾂ ﾂ },
ﾂ ﾂ ﾂ fields: ['id', 'slug_bairro', 'nome_bairro'],
ﾂ ﾂ ﾂ limit: -1,
ﾂ ﾂ })
ﾂ );

ﾂ const paths: { params: { slug: string } }[] = [];
ﾂﾂ
ﾂ for (const cat of categorias) {
ﾂ ﾂ if (!cat.full_slug_nicho) continue;
ﾂ ﾂ const baseSlug = String(cat.full_slug_nicho).replace(/^\/+|\/+$/g, '');

ﾂ ﾂ paths.push({ params: { slug: baseSlug } });

ﾂ ﾂ for (const bairro of bairros) {
ﾂ ﾂ ﾂ if (!bairro.slug_bairro) continue;
ﾂ ﾂ ﾂ const bairroSlug = String(bairro.slug_bairro).replace(/^\/+|\/+$/g, '');
ﾂ ﾂ ﾂ paths.push({ params: { slug: `${baseSlug}/${bairroSlug}` } });
ﾂ ﾂ }
ﾂ }

ﾂ return paths;
}

/**
ﾂ* 2) Lﾃｳgica da pﾃ｡gina em si: Carrega dados para a renderizaﾃｧﾃ｣o
ﾂ*/

// **RECALCULA CIDADE ID NO ESCOPO EXTERNO PARA A Lﾃ敵ICA DE RENDERIZAﾃﾃグ**
const cidade = await client.request(
ﾂ ﾂ readItems('mp_cidades', {
ﾂ ﾂ ﾂ filter: { slug_cidade: { _eq: CITY_SLUG } },ﾂ
ﾂ ﾂ ﾂ fields: ['id'],
ﾂ ﾂ ﾂ limit: 1,
ﾂ ﾂ })
);
const CIDADE_ID = cidade[0]?.id;

// Lﾃｳgica de fallback
if (!CIDADE_ID) {
ﾂ ﾂ return Astro.redirect('/404');
}

// ----------------------------------------------------------------------------------
// O restante do cﾃｳdigo abaixo ﾃｩ o mesmo que vocﾃｪ jﾃ｡ tinha.
// ----------------------------------------------------------------------------------

const slugParam = Astro.params.slug as string;
const cleanSlug = slugParam.replace(/^\/+|\/+$/g, '');
const parts = cleanSlug.split('/').filter(Boolean);

if (parts.length === 0) {
ﾂ return Astro.redirect('/404');
}

let categoryPath = '';
let geoSlug: string | null = null;
let categoria: Item | null = null;
let bairroOuRegiao: Item | null = null;

// Lﾃｳgica de parsing da URL para encontrar categoria e bairro (omitida para brevidade)
if (cleanSlug) {
ﾂ const categoriasFull = await client.request(
ﾂ ﾂ readItems('mp_categorias_locais', {
ﾂ ﾂ ﾂ filter: { full_slug_nicho: { _eq: cleanSlug }, ativo: { _eq: true } },
ﾂ ﾂ ﾂ limit: 1,
ﾂ ﾂ })
ﾂ );
ﾂ categoria = categoriasFull[0];
}

if (!categoria) {
ﾂ if (parts.length === 1) { return Astro.redirect('/404'); }
ﾂ geoSlug = parts[parts.length - 1];
ﾂ categoryPath = parts.slice(0, -1).join('/');

ﾂ const categoriasEncontradas = await client.request(
ﾂ ﾂ readItems('mp_categorias_locais', {
ﾂ ﾂ ﾂ filter: { full_slug_nicho: { _eq: categoryPath }, ativo: { _eq: true } },
ﾂ ﾂ ﾂ limit: 1,
ﾂ ﾂ })
ﾂ );
ﾂ categoria = categoriasEncontradas[0];

ﾂ if (!categoria) { return Astro.redirect('/404'); }
} else { categoryPath = cleanSlug; }

if (geoSlug) {
ﾂ const bairrosEncontrados = await client.request(
ﾂ ﾂ readItems('mp_bairros', {
ﾂ ﾂ ﾂ filter: { slug_bairro: { _eq: geoSlug }, ativo: { _eq: true }, status: { _eq: 'published' } },
ﾂ ﾂ ﾂ limit: 1,
ﾂ ﾂ })
ﾂ );
ﾂ bairroOuRegiao = bairrosEncontrados[0] ?? null;

ﾂ if (!bairroOuRegiao) { return Astro.redirect('/404'); }
}

// 3) Busca de cards: AGORA SEM EXPANSﾃグ DE CAMPO (M:M)
const cardsDeCidade = await client
ﾂ .request(
ﾂ ﾂ readItems('mp_cards_anunciantes', {
ﾂ ﾂ ﾂ filter: {
ﾂ ﾂ ﾂ ﾂ ativo: { _eq: true },
ﾂ ﾂ ﾂ ﾂ cidade_alvo: { _eq: CIDADE_ID }ﾂ
ﾂ ﾂ ﾂ },
ﾂ ﾂ ﾂ limit: 500,
ﾂ ﾂ ﾂ sort: ['sort', 'id'],
ﾂ ﾂ // CORREﾃﾃグ: SOLICITANDO CAMPOS RELACIONADOS M:M COMPLETOS PARA BAIRROS
ﾂ ﾂ ﾂ fields: [
ﾂ ﾂ ﾂ ﾂ '*',ﾂ
ﾂ ﾂ ﾂ ﾂ 'bairros_relacionados.*', // <-- EXPANSﾃグ NECESSﾃヽIA!
ﾂ ﾂ ﾂ ]
ﾂ ﾂ })
ﾂ )
ﾂ .catch(() => {
ﾂ ﾂ return [];
ﾂ });
ﾂﾂ
// Lﾃｳgica de filtragem dos Cards (MANTIDA, MAS NICHOS REFEITA)
const categoriaId = getId(categoria?.id);
const bairroId = bairroOuRegiao ? getId(bairroOuRegiao.id) : null;

const cards = (cardsDeCidade as any[]).filter((card) => {
ﾂ if (!card || card.ativo === false) return false;

ﾂ // Filtro Nichos
ﾂ const aplicaTodosNichos = !!card.aplica_todos_nichos;
ﾂ let bateNicho = aplicaTodosNichos;

ﾂ if (!bateNicho && categoriaId != null) {
ﾂ ﾂ const catRelId = getId(card.categoria_oferta_relacionada);
ﾂ ﾂ if (catRelId === categoriaId) { bateNicho = true; }

ﾂ ﾂ // NOVA Lﾃ敵ICA: PROCESSAMENTO DO CAMPO STRING 'nichos_locais_por_id'
ﾂ ﾂ if (!bateNicho && typeof card.nichos_locais_por_id === 'string' && card.nichos_locais_por_id) {
ﾂ ﾂ ﾂ // Converte o ID da URL para string para comparaﾃｧﾃ｣o consistente
ﾂ ﾂ ﾂ const currentCategoryId = String(categoriaId);ﾂ
ﾂ ﾂ ﾂﾂ
ﾂ ﾂ ﾂ const linkedIds = card.nichos_locais_por_id.split(',')
ﾂ ﾂ ﾂ ﾂ .map((id: string) => id.trim()); // Remove espaﾃｧos

ﾂ ﾂ ﾂ // Verifica se a lista de IDs digitada contﾃｩm o ID da categoria da URL
ﾂ ﾂ ﾂ if (linkedIds.includes(currentCategoryId)) {
ﾂ ﾂ ﾂ ﾂ bateNicho = true;
ﾂ ﾂ ﾂ }
ﾂ ﾂ }
ﾂ }

ﾂ if (!bateNicho) return false;

ﾂ // Filtro Bairro (Lﾃｳgica M:M ou M:1 para bairros permanece inalterada)
ﾂ if (!bairroId) return true;

ﾂ const aplicaTodosBairros = !!card.aplica_todos_bairros;

ﾂ if (aplicaTodosBairros) return true;

ﾂ if (Array.isArray(card.bairros_relacionados)) {
ﾂ ﾂ for (const b of card.bairros_relacionados) {
ﾂ ﾂ ﾂ const bId = getId(b);
ﾂ ﾂ ﾂ if (bId === bairroId) { return true; }
ﾂ ﾂ }
ﾂ }

ﾂ return false;
});


// Tﾃｭtulos, descriﾃｧﾃ｣o e textos dinﾃ｢micos (omitidos para brevidade)
const nomeCategoria = categoria?.nome_nicho ?? SITE_TAGLINE; // Usando a Tagline como fallback
const nomeGeo = bairroOuRegiao ? bairroOuRegiao.nome_bairro : null;

const tituloPagina = nomeGeo
ﾂ ? `${nomeCategoria} em ${nomeGeo}` : `${nomeCategoria} em ${CITY_NAME}`;
ﾂﾂ
const descricaoSEO =
ﾂ categoria?.seo_meta_description ??
ﾂ (nomeGeo
ﾂ ﾂ ? `Encontre ${SITE_TAGLINE.toLowerCase()} de ${nomeCategoria} no bairro ${nomeGeo} em ${CITY_NAME}.`
ﾂ ﾂ : `Encontre ${SITE_TAGLINE.toLowerCase()} de ${nomeCategoria} em toda a cidade de ${CITY_NAME}.`);
ﾂ ﾂﾂ
const textoGeoResumido = nomeGeo ? `no bairro ${nomeGeo}` : `em toda a cidade de ${CITY_NAME}`;
ﾂﾂ
const tituloPatrocinio = nomeGeo
ﾂ ? `Seja o patrocinador oficial desta pﾃ｡gina de ${nomeCategoria} em ${nomeGeo}`
ﾂ : `Seja o patrocinador oficial desta pﾃ｡gina de ${nomeCategoria} em ${CITY_NAME}`;
ﾂﾂ
const descricaoPatrocinioCurta = `Este espaﾃｧo 300x600 ﾃｩ reservado para destacar, em primeira posiﾃｧﾃ｣o, a sua marca de ${nomeCategoria} ${textoGeoResumido}.`;
const descricaoPatrocinioCompleta = `Aqui vocﾃｪ pode exibir um criativo no formato 300x600, atrair clientes do nicho ${nomeCategoria || 'local'} e ainda combinar com campanhas externas.`;

// Breadcrumbs (omitido para brevidade)
function slugToLabel(slug: string) {
ﾂ return slug.split('-').map((s) => (s ? s[0].toUpperCase() + s.slice(1) : '')).join(' ');
}

const baseSegments = categoryPath.split('/').filter(Boolean);

const breadcrumbs: Crumb[] = [];
breadcrumbs.push({ label: CITY_NAME, href: '/' });

let accumulated = '';
for (const seg of baseSegments) {
ﾂ accumulated += (accumulated ? '/' : '') + seg;
ﾂ breadcrumbs.push({ label: slugToLabel(seg), href: `/${accumulated}` });
}

if (nomeGeo) {
ﾂ breadcrumbs.push({ label: nomeGeo, href: null });
}

// Dados a serem passados
const layoutProps = {
ﾂ title: tituloPagina,
ﾂ description: descricaoSEO,
ﾂ adsenseClient: "ca-pub-3803893738575618",
ﾂ siteName: SITE_NAME,
ﾂ siteTagline: SITE_TAGLINE, // 泙 NOVO: CORREﾃﾃグ APLICADA AQUI
}

const cardSectionProps = {
ﾂ ﾂ cards: cards,
ﾂ ﾂ nomeCategoria: nomeCategoria,
ﾂ ﾂ nomeGeo: nomeGeo,
ﾂ ﾂ cleanSlug: cleanSlug,
ﾂ ﾂ tituloPatrocinio: tituloPatrocinio,
ﾂ ﾂ descricaoPatrocinioCurta: descricaoPatrocinioCurta,
ﾂ ﾂ descricaoPatrocinioCompleta: descricaoPatrocinioCompleta,
ﾂ ﾂ directusBaseUrl: DIRECTUS_BASE_URL,
ﾂ ﾂ getId: getId,
ﾂ ﾂ city_name: CITY_NAME,
}

---

<MainLayout {...layoutProps}>
ﾂ ﾂ <header style="margin-bottom: 1.5rem;">
ﾂ ﾂ ﾂ ﾂ <Breadcrumbs crumbs={breadcrumbs} />
ﾂ ﾂ ﾂ ﾂ 
ﾂ ﾂ ﾂ ﾂ {/* 閥 LINHA REMOVIDA: O texto "Negﾃｳcios Locais" foi movido para a tagline da logo no MainLayout */}
ﾂ ﾂ ﾂ ﾂ {/* ﾂ ﾂ ﾂ ﾂ <p style="margin: 0 0 0.25rem 0; font-size: 0.85rem; color: #666;">
ﾂ ﾂ ﾂ ﾂ ﾂ Negﾃｳcios Locais
ﾂ ﾂ ﾂ ﾂ </p>
ﾂ ﾂ ﾂ ﾂ */}

ﾂ ﾂ ﾂ ﾂ <h1 style="margin: 0 0 0.5rem 0; font-size: 1.8rem;">
ﾂ ﾂ ﾂ ﾂ ﾂ {nomeCategoria}
ﾂ ﾂ ﾂ ﾂ ﾂ {nomeGeo ? ` em ${nomeGeo}` : ''}
ﾂ ﾂ ﾂ ﾂ </h1>
ﾂ ﾂ ﾂ ﾂ {categoria?.descricao_curta_nicho && (
ﾂ ﾂ ﾂ ﾂ ﾂ <p style="margin: 0; color: #555;">
ﾂ ﾂ ﾂ ﾂ ﾂ ﾂ {categoria.descricao_curta_nicho}
ﾂ ﾂ ﾂ ﾂ ﾂ </p>
ﾂ ﾂ ﾂ ﾂ )}
ﾂ ﾂ ﾂ </header>
ﾂ ﾂ ﾂ <CardSection {...cardSectionProps} />
ﾂ ﾂ ﾂ <footer style="font-size: 0.8rem; color: #888;">
ﾂ ﾂ ﾂ ﾂ <p style="margin: 0;">
ﾂ ﾂ ﾂ ﾂ ﾂ Pﾃ｡gina dinﾃ｢mica de {CITY_NAME}.
ﾂ ﾂ ﾂ ﾂ </p>
ﾂ ﾂ ﾂ </footer>
</MainLayout>